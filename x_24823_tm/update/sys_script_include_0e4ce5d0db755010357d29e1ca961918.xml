<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_24823_tm.EventListnerUtils1</api_name>
        <caller_access>1</caller_access>
        <client_callable>false</client_callable>
        <description>This Script Include holds the generic functions  to process the  published TMF events .&#13;
The methods can be called any of the Mechanishm (PUSH- PULL)  or (PUSH - PUSH).</description>
        <name>EventListnerUtils1</name>
        <script><![CDATA[var EventListnerUtils1 = (function () {

    return {
        'processEventRequest': processEventRequest,
        "isNotificationRequest": isNotificationRequest
    };
    /***	 * isNotificationRequest -  will validate the input request is of Notification or not by checking the 'eventid' parameter in the requestbody
            * @param: (M) requestBody - request object as created in inbound scripted API
                 	
            * @return- true/false;
            *
            ***/

    function isNotificationRequest(requestBody) {
        try {
            /* Validation to accept only String/Object to verify it is a Notifiaton request or not */
            if ((typeof requestBody) !== 'string' && (typeof requestBody) !== 'object') {
                throw "The input requestBody to function 'isNotificationRequest' should be either Object/String ";
            }

            if ((typeof requestBody) === 'string') {
                requestBody = JSON.parse(requestBody); // converting into JSON object if the passed object is String
            }
            var eventIdNotExist = gs.nil(requestBody['eventId']);
            var eventTypeNotExist = gs.nil(requestBody['eventType']);
            var eventNotExist = gs.nil(requestBody['event']);

            if (eventIdNotExist) {
                throw "'eventId' attribute is missing.";
            }
            if (eventTypeNotExist) {
                throw "'eventType' attribute is missing.";
            }
            if (eventNotExist) {
                throw "'event'  attribute is missing.";
            }
            return "true";

        } catch (err) {
            gs.error("EventListnerUtils1::isNotificationRequest >> Error occured \n " + err.toString());
            return "false";
        }
    }
    /***	 * isNotificationRequest -  will validate the input request is of Notification or not by checking the 'eventid' parameter in the requestbody
               * @param: (M) requestBody - request object as created in inbound scripted API
            
          	
               * @return- GlideRecord Object of target record that was updated;
               *
               ***/

    function processEventRequest(requestBody) {
        try {
            var prefix = "$.event.";
            if (gs.nil(requestBody)) {
                throw "RequestBody Data is mandatory";
            }
            if (!isNotificationRequest) {
                throw "Request is not of Event notification type";
                
            }
            for (var key in requestBody.event) {
                prefix += key;
            }
            if (requestBody instanceof Object) {
                
                var configObj = getConfigurtationMetaData(requestBody);                
                if (gs.nil(configObj.servicenowTable)) {
                    throw "servicenowTable is not defined in the Mapping configuration record #" + grMappingConfig.number;
                }
                var colMapping = configObj.columnMapping;
                if (gs.nil(colMapping)) {
                    throw "ColumnMapping is not defined in the Mapping configuration record #" + grMappingConfig.number;
                }
            /*
            Check if there is any record already exist in Servicenow Database. 
            If found, update the record
             else insert the new recrod 
             */
                var grTargetRecord = new GlideRecord(configObj.servicenowTable + "");
                var uniqueJsonpathExp = "$.[?(@.unique=='true')]";
                var coaleseFields = global.jsonPath(columnMapping, uniqueJsonpathExp);

                for (var j in coaleseFields) {
                    grTargetRecord.addQuery(coaleseFields[j].servicenowColumn, global.jsonPath(requestData, prefix + colMapping[i].pathname));
                }
                grTargetRecord.setLimit(1);
                grTargetRecord.query();

                if (grTargetRecord.hasNext()) {
                    updateRecord(grTargetRecord, colMapping, requestData, prefix);
                } else {
                    createRecord(grTargetRecord, colMapping, requestData, prefix);
                }


                return grTargetRecord;


            }
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::processEventRequest >> Error occured \n " + err.toString());
            return x_24823_tm.WsErrorUtils.InvalidInput(err.toString());
        }
    }

    function getConfigurtationMetaData(requestData) {
        try {

            /* Query the mapping matrix table to fetch the corresponding configuration for the given basetype & type. 
             */
            var encQuery = "active=true";
            /* Filter with request @Basetype or * ie default value */
            encQuery = encQuery + (gs.nil(requestData["@baseType"])) ? "^base_type=*" : "^base_type=*^ORbase_type=" + requestData["@baseType"];
            /* Filter with request @Type or * ie default value  */
            encQuery = encQuery + (gs.nil(requestData["@type"])) ? "^type=*" : "^type=*^type=" + requestData["@type"];

            var grMappingConfig = new GlideRecord("x_24823_tm_mapping_sheet");
            grMappingConfig.addEncodedQuery(encQuery);
            grMappingConfig.orderByDesc('order'); // If multiple records are fetched, selected the record with hightest value in the Order field
            grMappingConfig.query();




            if (grMappingConfig.next()) {
                return JSON.parse(grMappingConfig.configuration_data);
            } else {
                throw "Active mapping configuration record not found with the BaseType {0}, Type {1}", [requestData["@baseType"], requestData["@type"]];
            }
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::getConfigurtationMetaData >> Error occured \n " + err.toString());

        }
    }

    function updateRecord(grTargetRecord, colMapping, requestData, prefix) {
        try {

            for (var i in colMapping) {
                setRecordField(grTargetRecord, colMapping[i], requestData, prefix);
                // grTargetRecord.setValue(colMapping[i].servicenowColumn + "", global.jsonPath(requestData, prefix + colMapping[i].pathname).toString());
            }
            grTargetRecord.update();
            return grTargetRecord;
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::updateRecord >> Error occured \n " + err.toString());

        }

    }

    function createRecord(grTargetRecord, colMapping, requestData, prefix) {
        try {
            grTargetRecord.initialize();
            for (var i in colMapping) {
                setRecordField(grTargetRecord, colMapping[i], requestData, prefix);
               
            }
            grTargetRecord.insert();
            return grTargetRecord;
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::createRecord >> Error occured \n " + err.toString());

        }

    }

    function setRecordField(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            switch (colMappingMetaData['type'] + "") {
                case "choice":
                    setChoiceField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "constant":
                    setConstantField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "referenceField":
                   /* setReferenceField(grTargetRecord, colMappingMetaData, requestData, prefix); */
                    break;
                case "referenceTable":
                   /* setReferenceTable(grTargetRecord, colMappingMetaData, requestData, prefix); */
                    break;
                case "collection":
                    setCollectionField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "true/false":
                    setBooleanField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "string":
                default:
                    setStringField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
            }

        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setChoiceField >> Error occured \n " + err.toString());

        }
    }

    function setChoiceField(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            
            var inputVal = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);
            var jsonpathExp = "$.[*].choiceMapping.[?(@.sourceValue=='" + inputVal + "')].targetValue";
            var targetVal = global.jsonPath(colMappingMetaData, jsonpathExp);
            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", targetVal);

        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setChoiceField >> Error occured \n " + err.toString());

        }

    }

    function setReferenceField(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            
            var refTable = global.jsonPath(colMappingMetaData, "$.referenceTable");
            var jsonpathExp4RefId = "$.[*].referenceFieldMapping.[?(@.RefUnique=='true')]";
            var refMap = global.jsonPath(colMappingMetaData, jsonpathExp4RefId);
            var sourceRefId = global.jsonPath(requestData, prefix + colMappingMetaData.pathname + "." + refMap.pathname);
            var refCol = refMap.servicenowColumn;
            var grRefTable = new GlideRecord(refTable);
            if (grRefTable.get(refCol, sourceRefId)) {
                grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", targetVal);
            } else {
                /* If the target record not found, create a new one with the provided information */
                var refColMapping = global.jsonPath(colMappingMetaData, "$.referenceFieldMapping");
                grRefTable.initialize();
                createRecord(grRefTable, refColMapping, requestData, prefix);

                grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", grRefTable.sys_id+""); 
            }
            

        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setReferenceField >> Error occured \n " + err.toString());

        }
    }

    function setReferenceTable(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {

            var refTable = global.jsonPath(colMappingMetaData, "$.referenceTable");
            var jsonpathExp4RefId = "$.[*].referenceFieldMapping.[?(@.RefUnique=='true')]";
            var refMap = global.jsonPath(colMappingMetaData, jsonpathExp4RefId);
            var sourceRefId = global.jsonPath(requestData, prefix + colMappingMetaData.pathname + "." + refMap.pathname);
            var refCol = refMap.servicenowColumn;
            var grRefTable = new GlideRecord(refTable);
            if (grRefTable.get(refCol, sourceRefId)) {
                grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", targetVal);
            } else {
                /* If the target record not found, create a new one with the provided information */
                var refColMapping = global.jsonPath(colMappingMetaData, "$.referenceFieldMapping");
                grRefTable.initialize();
                createRecord(grRefTable, refColMapping, requestData, prefix);

                grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", grRefTable.sys_id + "");
            }

        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setReferenceTable >> Error occured \n " + err.toString());

        }
    }
/* This function will fetch the servicenow record internal sys_id based on the input parameters. If the record is not found, then it will insert the record. This function is used for Referece field settings 
@Input "table_name" >> 
@Input "fieldMapping" >>

@output servicenow record sys_id.
*/
    
    function getSerRecId(table_name, fieldMapping) {
        try {
            var record = new GlideRecord(table_name);
            for (var key in fieldMapping) {
                if (fieldMapping.hasOwnProperty(key)) {
                    
                    record.addQuery(key, fieldMapping[key]);
                }
            }
            record.setLimit(1);
            record.query();
            if (record.hasNext()) {
               record.next();
                
            } else {
                record.initialize();
                for(var key in fieldMapping) {
                    if (fieldMapping.hasOwnProperty(key)) {

                        record.setValue(key, fieldMapping[key]);
                    }
                } 
                record.insert();
            }
           return record.getUniqueValue();
        } catch (error) {
            gs.addErrorMessage("EventListnerUtils1::getSerRecId >> Error occured \n " + err.toString());
            return "";
        }
    }

    function setBooleanField(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            var inputVal = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);
            var jsonpathExp = "$.[*].boleanMapping.[?(@.sourceValue=='" + inputVal + "')].targetValue";
            var targetVal = global.jsonPath(colMappingMetaData, jsonpathExp);
            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", targetVal);
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setBooleanField >> Error occured \n " + err.toString());

        }
    }

    function setCollectionField(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            var existingValue = grTargetRecord.getValue(colMappingMetaData.servicenowColumn) + "\n";
            var pathValue = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);
            if (typeof pathValue == "string") {
                existingValue += colMappingMetaData.pathname + "\t\t:" + pathValue;
            }else if (typeof pathValue == "object") {
                existingValue += colMappingMetaData.pathname + "\t\t:" + JSON.parse(pathValue);
            } else {
                existingValue += colMappingMetaData.pathname + "\t\t:" + pathValue;
            }

            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", existingValue);
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setCollectionField >> Error occured \n " + err.toString());

        }
    }

    function setStringField(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", (global.jsonPath(requestData, prefix + colMappingMetaData.pathname)).join());
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setStringField >> Error occured \n " + err.toString());

        }
    }
    function setConstantField(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", colMappingMetaData.pathname);
        } catch (err) {
            gs.addErrorMessage("EventListnerUtils1::setStringField >> Error occured \n " + err.toString());

        }
    }
})();]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>viswanath23@gmail.com</sys_created_by>
        <sys_created_on>2020-06-30 09:43:52</sys_created_on>
        <sys_id>0e4ce5d0db755010357d29e1ca961918</sys_id>
        <sys_mod_count>12</sys_mod_count>
        <sys_name>EventListnerUtils1</sys_name>
        <sys_package display_value="TMF catalyst" source="x_24823_tm">f770b6d1db185050357d29e1ca96196f</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="TMF catalyst">f770b6d1db185050357d29e1ca96196f</sys_scope>
        <sys_update_name>sys_script_include_0e4ce5d0db755010357d29e1ca961918</sys_update_name>
        <sys_updated_by>viswanath23@gmail.com</sys_updated_by>
        <sys_updated_on>2020-07-06 16:35:55</sys_updated_on>
    </sys_script_include>
</record_update>
