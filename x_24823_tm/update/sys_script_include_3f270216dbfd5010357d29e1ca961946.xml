<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_24823_tm.EventListnerUtils</api_name>
        <caller_access>1</caller_access>
        <client_callable>false</client_callable>
        <description/>
        <name>EventListnerUtils</name>
        <script><![CDATA[var EventListnerUtils = Class.create();
EventListnerUtils.prototype = {
    initialize: function() {
        this.RECORD_UPDATED = "";
        this.EVENT_PREFIX = "$.event.";
    },
    /***	 * isNotificationRequest -  will validate the input request is of Notification or not by checking the 'eventid' parameter in the requestbody
               * @param: (M) requestBody - request object as created in inbound scripted API
                    	
               * @return- true/false;
               *
               ***/

    isNotificationRequest: function(requestBody) {
        try {
            /* Validation to accept only String/Object to verify it is a Notifiaton request or not */
            if ((typeof requestBody) !== 'string' && (typeof requestBody) !== 'object') {
                throw "The input requestBody to function 'isNotificationRequest' should be either Object/String ";
            }

            if ((typeof requestBody) === 'string') {
                requestBody = JSON.parse(requestBody); // converting into JSON object if the passed object is String
            }
            var eventIdNotExist = gs.nil(requestBody['eventId']);
            var eventTypeNotExist = gs.nil(requestBody['eventType']);
            var eventNotExist = gs.nil(requestBody['event']);

            if (eventIdNotExist) {
                throw "'eventId' attribute is missing.";
            }
            if (eventTypeNotExist) {
                throw "'eventType' attribute is missing.";
            }
            if (eventNotExist) {
                throw "'event'  attribute is missing.";
            }
            return "true";

        } catch (err) {
            gs.error("EventListnerUtils1::isNotificationRequest >> Error occured \n " + err.toString());
            return "false";
        }
    },
    /***	 * isNotificationRequest -  will validate the input request is of Notification or not by checking the 'eventid' parameter in the requestbody
               * @param: (M) requestBody - request object as created in inbound scripted API
            
          	
               * @return- GlideRecord Object of target record that was updated;
               *
               ***/

    processEventRequest: function(requestBody) {

        try {
            var prefix = "$.event.";
            if (gs.nil(requestBody)) {
                throw "RequestBody Data is mandatory";
            }
            if (!this.isNotificationRequest) {
                throw "Request is not of Event notification type";

            }
            for (var key in requestBody.event) {
                prefix += key + ".";
            }
            if (requestBody instanceof Object) {

                var mappingObj = this.getConfigurtationMetaData(requestBody, prefix);
                if (gs.nil(mappingObj)) {
                    throw "Mapping object not found";
                }
                var configObj = JSON.parse(mappingObj.configuration_data);
                if (gs.nil(configObj.servicenowTable)) {
                    throw "servicenowTable is not defined in the Mapping configuration record #" + mappingObj.number;
                }

                var colMapping = configObj.columnMapping;
                if (gs.nil(colMapping)) {
                    throw "ColumnMapping is not defined in the Mapping configuration record #" + mappingObj.number;
                }
                /*
                Check if there is any record already exist in Servicenow Database. 
                If found, update the record
                 else insert the new recrod 
                 */
                var grTargetRecord = new GlideRecord(configObj.servicenowTable + "");
                var uniqueJsonpathExp = "$.[?(@.unique=='true')]";
                var coaleseFields = global.jsonPath(colMapping, uniqueJsonpathExp);

                for (var j in coaleseFields) {
                    var pathValue = global.jsonPath(requestBody, prefix + coaleseFields[j].pathname);
                    if ((typeof pathValue) === "object") {
                        grTargetRecord.addQuery(coaleseFields[j].servicenowColumn, pathValue.join());
                    }
                }

                grTargetRecord.setLimit(1);
                grTargetRecord.query();

                if (grTargetRecord.next()) {
                    this.updateRecord(grTargetRecord, colMapping, requestBody, prefix);
                } else {
                    this.createRecord(grTargetRecord, colMapping, requestBody, prefix);
                }
                this.RECORD_UPDATED = grTargetRecord.getUniqueValue();
                this.executePostUpsert(grTargetRecord, colMapping, requestBody, prefix);
                var returnObj = {};
                returnObj['status'] = "success";
                returnObj['record'] = grTargetRecord;
                return returnObj;


            }
        } catch (err) {
            gs.error("EventListnerUtils1::processEventRequest >> Error occured \n " + err.toString());

            var errObj = x_24823_tm.WsErrorUtils.InvalidInput(err.toString());

            returnObj['status'] = "failed";
            returnObj['record'] = errObj;
            return returnObj;

        }
    },

    executePostUpsert: function(grTargetRecord, colMapping, requestBody, prefix) {
        try {
            var refTblJsonpathExp = "$.[?(@.type=='referenceTable')]";
            var refTableMappingArr = global.jsonPath(colMapping, refTblJsonpathExp);
            for (var i in refTableMappingArr) {
                var colMappingMetaData = refTableMappingArr[i];
                this.setReferenceTable(colMappingMetaData, requestBody, prefix);

            }

        } catch (err) {
            gs.error("EventListnerUtils1::executePostUpsert >> Error occured \n " + err.toString());

            var errObj = x_24823_tm.WsErrorUtils.InvalidInput(err.toString());

        }
    },
    getConfigurtationMetaData: function(requestData, prefix) {
        try {
            /* Query the mapping matrix table to fetch the corresponding configuration for the given basetype & type. 
             */
//gs.info("getConfigurtationMetaData::prefix >> "+prefix);
//			gs.info("getConfigurtationMetaData::requestData "+JSON.stringify(requestData));
            var encQuery = "active=true";

            var baseTypeVal = global.jsonPath(requestData, prefix + "@baseType");
            /* Filter with request @Basetype or with '*' ie default value */
            if (baseTypeVal) {
                encQuery += "^base_type=*^ORbase_type=" + baseTypeVal;
            } else {
                encQuery += "^base_type=*";
            }

            var typeVal = global.jsonPath(requestData, prefix + "@type");

            /* Filter with request @Type or * ie default value  */
            if (typeVal) {
                encQuery += "^type=*^ORtype=" + typeVal;
            } else {
                encQuery += "^type=*";
            }


            var grMappingConfig = new GlideRecord("x_24823_tm_mapping_sheet");
            grMappingConfig.addEncodedQuery(encQuery);
            grMappingConfig.orderByDesc('order'); // If multiple records are fetched, selected the record with hightest value in the Order field
            grMappingConfig.setLimit(1);
            grMappingConfig.query();




            if (grMappingConfig.next()) {
                return grMappingConfig;
            } else {
                throw "Active mapping configuration record not found with the BaseType " + baseTypeVal + " & Type " + typeVal;
            }
        } catch (err) {
            gs.error("EventListnerUtils1::getConfigurtationMetaData >> Error occured \n " + err.toString());
            return "";
        }
    },

    updateRecord: function(grTargetRecord, colMapping, requestData, prefix) {
        gs.debug("EventListnerUtils1::updateRecord >> Starts ");
        try {

            for (var i in colMapping) {
                this.setRecordField(grTargetRecord, colMapping[i], requestData, prefix);
                // grTargetRecord.setValue(colMapping[i].servicenowColumn + "", global.jsonPath(requestData, prefix + colMapping[i].pathname).toString());
            }
            grTargetRecord.update();
            gs.debug("EventListnerUtils1::updateRecord >> Ends ");
            return grTargetRecord;
        } catch (err) {
            gs.error("EventListnerUtils1::updateRecord >> Error occured \n " + err.toString());

        }

    },

    createRecord: function(grTargetRecord, colMapping, requestData, prefix) {
        try {
            gs.debug("EventListnerUtils1::createRecord >> Starts \n colMapping :: {0} \n requestData :: {1}", [JSON.stringify(colMapping), JSON.stringify(requestData)]);
            for (var i in colMapping) {
                this.setRecordField(grTargetRecord, colMapping[i], requestData, prefix);

            }
            grTargetRecord.insert();
            gs.debug("EventListnerUtils1::createRecord >> Ends ");
            return grTargetRecord;
        } catch (err) {
            gs.error("EventListnerUtils1::createRecord >> Error occured \n " + err.toString());

        }

    },

    setRecordField: function(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            switch (colMappingMetaData['type'] + "") {
                case "choice":
                    this.setChoiceField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "constant":
                    this.setConstantField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "referenceField":
                    this.setReferenceField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "referenceTable":
                /*   this.setReferenceTable(grTargetRecord, colMappingMetaData, requestData, prefix);*/
                    break;
                case "collection":
                    this.setCollectionField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "true/false":
                    this.setBooleanField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
                case "string":
                default:
                    this.setStringField(grTargetRecord, colMappingMetaData, requestData, prefix);
                    break;
            }

        } catch (err) {
            gs.error("EventListnerUtils1::setChoiceField >> Error occured \n " + err.toString());

        }
    },

    setChoiceField: function(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {

            var inputVal = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);
            var jsonpathExp = "$.[*].choiceMapping.[?(@.sourceValue=='" + inputVal + "')].targetValue";
            var targetVal = global.jsonPath(colMappingMetaData, jsonpathExp);
            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", targetVal);

        } catch (err) {
            gs.error("EventListnerUtils1::setChoiceField >> Error occured \n " + err.toString());

        }

    },

    setReferenceField: function(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            gs.debug("EventListnerUtils1::setReferenceField >> Starts ");
            var refTable = global.jsonPath(colMappingMetaData, "$.referenceTable");
            var jsonpathExp4RefId = "$.referenceFieldMapping[?(@.RefUnique)]";
            var refMap = global.jsonPath(colMappingMetaData, jsonpathExp4RefId);
            var sourceRefId = global.jsonPath(requestData, prefix + colMappingMetaData.pathname + "." + refMap[0].pathname);
            var refCol = refMap[0].servicenowColumn;
            var grRefTable = new GlideRecord(refTable);
            grRefTable.addQuery(refCol, sourceRefId);
            grRefTable.setLimit(1);
            grRefTable.query();
            if (grRefTable.next()) {
                grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", grRefTable.sys_id + "");
            } else {
                /* If the target record not found, create a new one with the provided information */
                prefix = prefix + colMappingMetaData.pathname + ".";
                //var refColMapping = global.jsonPath(colMappingMetaData, "$.referenceFieldMapping");
                var refColMapping = colMappingMetaData.referenceFieldMapping;
                this.createRecord(grRefTable, refColMapping, requestData, prefix);

                grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", grRefTable.sys_id + "");
            }
            gs.debug("EventListnerUtils1::setReferenceField >> Ends ");

        } catch (err) {
            gs.error("EventListnerUtils1::setReferenceField >> Error occured \n " + err.toString());

        }
    },

    setReferenceTable: function(colMappingMetaData, requestData, prefix) {
        try {

            gs.debug("EventListnerUtils1::setReferenceTable >> Starts ");
            var refRelationships = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);

            if (Array.isArray(refRelationships)) {
                var refTable = colMappingMetaData.referenceTable + "";
                var jsonpathExp4RefId = "$.referenceFieldMapping[?(@.RefUnique)]";
                var refMap = global.jsonPath(colMappingMetaData, jsonpathExp4RefId);

                for (var key in refRelationships[0]) {
                    var refRelRecord = refRelationships[0][key];


                    var refCol = refMap[0].servicenowColumn;
                    var sourceRefId = "NULL";
                    if (refMap[0].type == "referenceField") {
                        sourceRefId = this.getSerRecId(refMap[0], refRelRecord);
                    } else {
                        sourceRefId = refRelRecord[refMap[0].pathname];
                    }

                    var jsonpathExp4_others = '$.referenceFieldMapping[?(@.RefUnique != "true")]';
                    var otherMapping = global.jsonPath(colMappingMetaData, jsonpathExp4_others);


                    var grRefTable = new GlideRecord(refTable);
                    grRefTable.addQuery(refCol, sourceRefId);
                    grRefTable.addQuery(colMappingMetaData.servicenowColumn, this.RECORD_UPDATED);
                    grRefTable.setLimit(1);
                    grRefTable.query();

                    if (grRefTable.next()) {

                        for (var i in otherMapping) {
                            this.setRecordField(grRefTable, otherMapping[i], refRelRecord, "$.");
                        }
                        grRefTable.update();
                    } else {
                        grRefTable.setValue(colMappingMetaData.servicenowColumn, this.RECORD_UPDATED);
                        grRefTable.setValue(refCol, sourceRefId);


                        for (i in otherMapping) {
                            this.setRecordField(grRefTable, otherMapping[i], refRelRecord, "$.");
                        }
                        grRefTable.insert();

                    }
                }
                gs.debug("EventListnerUtils1::setReferenceTable >> Ends ");
            }
        } catch (err) {
            gs.error("EventListnerUtils1::setReferenceTable >> Error occured \n " + err.toString());

        }
    },
    /* This function will fetch the servicenow record internal sys_id based on the input parameters. If the record is not found, then it will insert the record. This function is used for Referece field settings 
    @Input "table_name" >> 
    @Input "fieldMapping" >>

    @output servicenow record sys_id.
    */

    getSerRecId: function(refMapping, requestBody) {
        try {
            var refUniqueMaping = global.jsonPath(refMapping, "$.referenceFieldMapping[?(@.RefUnique)]");
            // gs.info(refUniqueMaping[0].servicenowColumn);
            // gs.info(requestBody[refUniqueMaping[0].pathname]);
            var grRec = new GlideRecord(refMapping.referenceTable);
            grRec.addQuery(refUniqueMaping[0].servicenowColumn, requestBody[refUniqueMaping[0].pathname]);
            grRec.query();
            if (grRec.hasNext()) {
                grRec.next();
            } else {
                var refFieldMappings = refMapping.referenceFieldMapping;
                grRec.initialize();
                for (var i in refFieldMappings) {
                    var refFieldMap = refFieldMappings[i];
                    gs.info("Servicenow column {0}, value {1}", [refFieldMap.servicenowColumn, requestBody[refFieldMap.pathname]]);
                    grRec.setValue(refFieldMap.servicenowColumn + "", requestBody[refFieldMap.pathname]);
                }
                grRec.insert();

            }
            return grRec.getUniqueValue();
        } catch (error) {
            gs.error("EventListnerUtils1::getSerRecId >> Error occured \n " + err.toString());
            return "";
        }
    },

    setBooleanField: function(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            var inputVal = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);
            var jsonpathExp = "$.[*].boleanMapping.[?(@.sourceValue=='" + inputVal + "')].targetValue";
            var targetVal = global.jsonPath(colMappingMetaData, jsonpathExp);
            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", targetVal);
        } catch (err) {
            gs.error("EventListnerUtils1::setBooleanField >> Error occured \n " + err.toString());

        }
    },

    setCollectionField: function(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            var existingValue = grTargetRecord.getValue(colMappingMetaData.servicenowColumn) + "\n";
            var pathValue = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);
            if (typeof pathValue == "string") {
                existingValue += colMappingMetaData.pathname + "\t\t:" + pathValue;
            } else if (typeof pathValue == "object") {
                existingValue += colMappingMetaData.pathname + "\t\t:" + JSON.stringify(pathValue);
            } else {
                existingValue += colMappingMetaData.pathname + "\t\t:" + pathValue;
            }

            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", existingValue);
        } catch (err) {
            gs.error("EventListnerUtils1::setCollectionField >> Error occured \n " + err.toString());

        }
    },

    setStringField: function(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            var pathValue = global.jsonPath(requestData, prefix + colMappingMetaData.pathname);

            if ((typeof pathValue) === 'object') {
                grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", pathValue.join());
            }
        } catch (err) {
            gs.error("EventListnerUtils1::setStringField >> Error occured \n " + err.toString());

        }
    },
    setConstantField: function(grTargetRecord, colMappingMetaData, requestData, prefix) {
        try {
            grTargetRecord.setValue(colMappingMetaData.servicenowColumn + "", colMappingMetaData.pathname);
        } catch (err) {
            gs.error("EventListnerUtils1::setStringField >> Error occured \n " + err.toString());

        }
    },
    type: 'EventListnerUtils'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>viswanath23@gmail.com</sys_created_by>
        <sys_created_on>2020-07-06 16:40:36</sys_created_on>
        <sys_id>3f270216dbfd5010357d29e1ca961946</sys_id>
        <sys_mod_count>68</sys_mod_count>
        <sys_name>EventListnerUtils</sys_name>
        <sys_package display_value="TMF catalyst" source="x_24823_tm">f770b6d1db185050357d29e1ca96196f</sys_package>
        <sys_policy>protected</sys_policy>
        <sys_scope display_value="TMF catalyst">f770b6d1db185050357d29e1ca96196f</sys_scope>
        <sys_update_name>sys_script_include_3f270216dbfd5010357d29e1ca961946</sys_update_name>
        <sys_updated_by>arup.sinha</sys_updated_by>
        <sys_updated_on>2020-07-17 12:02:20</sys_updated_on>
    </sys_script_include>
</record_update>
